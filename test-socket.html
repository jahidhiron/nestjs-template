<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Realtime Profile Updates</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }

      #status {
        padding: 8px 12px;
        background: #eef2ff;
        border-left: 4px solid #4b6cb7;
        margin-bottom: 20px;
        border-radius: 6px;
        font-size: 14px;
      }

      .profile {
        padding: 6px 10px;
        background: #e9ffe9;
        border: 1px solid #9ad29a;
        margin-bottom: 6px;
        border-radius: 4px;
        font-size: 13px;
      }

      #loader {
        display: none;
        width: 24px;
        height: 24px;
        border: 4px solid #4b6cb7;
        border-top: 4px solid #eef2ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <h1>Realtime Profile Updates</h1>

    <div id="status">Connecting...</div>
    <div id="loader"></div>
    <div id="profiles"></div>

    <!-- Socket.io client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const profileBox = document.getElementById('profiles');
      const statusBox = document.getElementById('status');
      const loader = document.getElementById('loader');

      const socket = io('http://localhost:8080/realtime', {
        extraHeaders: { authorization: 'Bearer dummy-token' },
      });

      socket.on('connect', () => {
        statusBox.textContent = `Connected ✔️ (Socket ID: ${socket.id})`;

        socket.emit('connect_ack', {
          name: 'Jahid Hiron',
          timestamp: new Date().toISOString(),
        });
      });

      socket.on('disconnect', () => {
        statusBox.textContent = 'Disconnected ❌';
      });

      socket.on('connect_ack', (data) => {
        // data is { message: string, at: string }
        console.log('Connect ACK from server:', data);
        statusBox.textContent = `Connected ✔️ ${data.message} at ${data.at}`;
      });

      function showLoader() {
        loader.style.display = 'block';
        setTimeout(() => (loader.style.display = 'none'), 800);
      }

      // Listen to backend updates
      socket.on('profile_update', (profile) => {
        showLoader();

        const div = document.createElement('div');
        div.className = 'profile';
        div.innerHTML = `
        <b>ID:</b> ${profile.id}<br/>
        <b>Version:</b> ${profile.version}<br/>
        <b>Last Process At:</b> ${profile.lastProcessedAt || 'N/A'}
      `;
        profileBox.prepend(div);

        // After receiving profile.update, send event back to backend
        socket.emit('get_profile', { id: profile.id, status: 'received' });
      });
    </script>
  </body>
</html>
